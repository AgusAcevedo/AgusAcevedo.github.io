---
import { useTranslations } from "../i18n";
import type { Language } from "../i18n/languages";

const currentLocale = (Astro.currentLocale || 'es') as Language;
const t = useTranslations(currentLocale);

// Dev.to username - cambia esto por tu username
const DEVTO_USERNAME = 'agusacevedo';
const DEVTO_PROFILE = `https://dev.to/${DEVTO_USERNAME}`;

// Define types
interface Article {
  id: number;
  title: string;
  description: string;
  url: string;
  cover_image: string | null;
  published_at: string;
  tags: string[];
  reading_time: number;
}

// Fetch articles from Dev.to RSS feed
let articles: Article[] = [];
try {
  const response = await fetch(`https://dev.to/api/articles?username=${DEVTO_USERNAME}&per_page=3`);
  if (response.ok) {
    const data = await response.json();
    articles = data.map((article: any) => ({
      id: article.id,
      title: article.title,
      description: article.description,
      url: article.url,
      cover_image: article.cover_image || article.social_image,
      published_at: new Date(article.published_at).toLocaleDateString(currentLocale, {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      }),
      tags: article.tag_list,
      reading_time: article.reading_time_minutes,
    }));
  }
} catch (error) {
  console.error('Error fetching Dev.to articles:', error);
}
---

<div class="space-y-8">
  {articles.length > 0 ? (
    <>
      <!-- Desktop: Grid -->
      <div class="hidden md:grid gap-6 md:grid-cols-2 lg:grid-cols-3">
        {articles.map((article) => (
          <article
            class="blog-card group relative overflow-hidden rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900/50 transition-all hover:border-violet-400 dark:hover:border-violet-600 hover:shadow-xl hover:shadow-violet-500/10 dark:hover:shadow-violet-500/5"
          >
            <a
              href={article.url}
              target="_blank"
              rel="noopener noreferrer"
              class="block"
            >
              {article.cover_image && (
                <div class="aspect-[1000/420] overflow-hidden bg-gray-100 dark:bg-gray-800">
                  <img
                    src={article.cover_image}
                    alt={article.title}
                    class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                    loading="lazy"
                  />
                </div>
              )}
              
              <div class="p-6 space-y-4">
                <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-500">
                  <time>{article.published_at}</time>
                  {article.reading_time && (
                    <>
                      <span>•</span>
                      <span>{article.reading_time} min {t.blog.read}</span>
                    </>
                  )}
                </div>

                <h3 class="text-xl font-bold text-gray-800 dark:text-white leading-tight group-hover:text-violet-600 dark:group-hover:text-violet-400 transition-colors line-clamp-2">
                  {article.title}
                </h3>

                {article.description && (
                  <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-3">
                    {article.description}
                  </p>
                )}

                {article.tags && article.tags.length > 0 && (
                  <div class="flex flex-wrap gap-2">
                    {article.tags.slice(0, 3).map((tag: string) => (
                      <span class="text-xs px-2 py-1 rounded-full bg-violet-100 dark:bg-violet-900/40 text-violet-600 dark:text-violet-400">
                        #{tag}
                      </span>
                    ))}
                  </div>
                )}
              </div>

              <!-- Decorative gradient -->
              <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-violet-500/5 to-transparent rounded-full blur-2xl -z-10 group-hover:from-violet-500/10 transition-all" />
            </a>
          </article>
        ))}
      </div>

      <!-- Mobile: Carousel -->
      <div class="md:hidden relative px-4">
        <div class="overflow-hidden">
          <div id="blog-carousel" class="flex transition-transform duration-300 ease-out">
            {articles.map((article, index) => (
              <article
                class="blog-card-mobile min-w-full px-2"
                data-index={index}
              >
                <div class="group relative overflow-hidden rounded-2xl border border-gray-200 dark:border-gray-800 bg-white dark:bg-gray-900/50 transition-all hover:border-violet-400 dark:hover:border-violet-600 hover:shadow-xl hover:shadow-violet-500/10 dark:hover:shadow-violet-500/5">
                  <a
                    href={article.url}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="block"
                  >
                    {article.cover_image && (
                      <div class="aspect-[1000/420] overflow-hidden bg-gray-100 dark:bg-gray-800">
                        <img
                          src={article.cover_image}
                          alt={article.title}
                          class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300"
                          loading="lazy"
                        />
                      </div>
                    )}
                    
                    <div class="p-6 space-y-4">
                      <div class="flex items-center gap-2 text-xs text-gray-500 dark:text-gray-500">
                        <time>{article.published_at}</time>
                        {article.reading_time && (
                          <>
                            <span>•</span>
                            <span>{article.reading_time} min {t.blog.read}</span>
                          </>
                        )}
                      </div>

                      <h3 class="text-xl font-bold text-gray-800 dark:text-white leading-tight group-hover:text-violet-600 dark:group-hover:text-violet-400 transition-colors line-clamp-2">
                        {article.title}
                      </h3>

                      {article.description && (
                        <p class="text-sm text-gray-600 dark:text-gray-400 line-clamp-3">
                          {article.description}
                        </p>
                      )}

                      {article.tags && article.tags.length > 0 && (
                        <div class="flex flex-wrap gap-2">
                          {article.tags.slice(0, 3).map((tag: string) => (
                            <span class="text-xs px-2 py-1 rounded-full bg-violet-100 dark:bg-violet-900/40 text-violet-600 dark:text-violet-400">
                              #{tag}
                            </span>
                          ))}
                        </div>
                      )}
                    </div>

                    <!-- Decorative gradient -->
                    <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-violet-500/5 to-transparent rounded-full blur-2xl -z-10 group-hover:from-violet-500/10 transition-all" />
                  </a>
                </div>
              </article>
            ))}
          </div>
        </div>

        <!-- Carousel Controls -->
        <nav class="flex items-center justify-center gap-4 mt-6" aria-label="Blog carousel pagination">
          <button
            id="blog-prev"
            class="px-4 py-2 rounded-lg font-semibold border transition disabled:opacity-30 disabled:cursor-not-allowed bg-violet-100 text-violet-700 border-violet-200 hover:bg-violet-200 dark:bg-violet-600/20 dark:text-white dark:border-violet-600/40 dark:hover:bg-violet-600/30 focus:outline-none focus-visible:ring-2 focus-visible:ring-violet-500"
            aria-label="Previous articles"
          >
            &lt;
          </button>
          <div class="flex justify-center gap-2">
            {articles.map((_, index) => (
              <button
                class="blog-dot size-2 rounded-full bg-gray-300 dark:bg-gray-600 transition-all"
                data-index={index}
                aria-label={`Go to slide ${index + 1}`}
              />
            ))}
          </div>
          <button
            id="blog-next"
            class="px-4 py-2 rounded-lg font-semibold border transition disabled:opacity-30 disabled:cursor-not-allowed bg-violet-100 text-violet-700 border-violet-200 hover:bg-violet-200 dark:bg-violet-600/20 dark:text-white dark:border-violet-600/40 dark:hover:bg-violet-600/30 focus:outline-none focus-visible:ring-2 focus-visible:ring-violet-500"
            aria-label="Next articles"
          >
            &gt;
          </button>
        </nav>
      </div>

      <div class="flex justify-center">
        <a
          href={DEVTO_PROFILE}
          target="_blank"
          rel="noopener noreferrer"
          class="inline-flex items-center gap-2 px-6 py-3 rounded-full bg-violet-600 hover:bg-violet-700 dark:bg-violet-500 dark:hover:bg-violet-600 text-white font-medium transition-colors"
        >
          {t.blog.viewMore}
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M5 12h14"></path>
            <path d="M12 5l7 7-7 7"></path>
          </svg>
        </a>
      </div>
    </>
  ) : (
    <div class="text-center py-12 text-gray-500 dark:text-gray-500">
      {t.blog.noArticles}
    </div>
  )}
</div>

<style>
  .blog-card {
    opacity: 0;
    transform: translateY(20px);
    animation: fadeInUp 0.5s ease-out forwards;
  }

  .blog-card:nth-child(1) { animation-delay: 0.1s; }
  .blog-card:nth-child(2) { animation-delay: 0.2s; }
  .blog-card:nth-child(3) { animation-delay: 0.3s; }

  @keyframes fadeInUp {
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .blog-dot.active {
    background-color: rgb(139 92 246);
    width: 1.5rem;
  }
</style>

<script>
  let currentSlide = 0;
  const carousel = document.getElementById('blog-carousel');
  const dots = document.querySelectorAll('.blog-dot');
  const prevBtn = document.getElementById('blog-prev') as HTMLButtonElement;
  const nextBtn = document.getElementById('blog-next') as HTMLButtonElement;
  const totalSlides = dots.length;

  function updateCarousel() {
    if (carousel) {
      carousel.style.transform = `translateX(-${currentSlide * 100}%)`;
    }
    
    dots.forEach((dot, index) => {
      if (index === currentSlide) {
        dot.classList.add('active');
      } else {
        dot.classList.remove('active');
      }
    });

    // Update button states
    if (prevBtn) prevBtn.disabled = currentSlide === 0;
    if (nextBtn) nextBtn.disabled = currentSlide === totalSlides - 1;
  }

  function nextSlide() {
    currentSlide = (currentSlide + 1) % totalSlides;
    updateCarousel();
  }

  function prevSlide() {
    currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
    updateCarousel();
  }

  // Initialize
  updateCarousel();

  // Auto-advance carousel every 5 seconds
  let autoAdvance = setInterval(nextSlide, 5000);

  // Button navigation
  prevBtn?.addEventListener('click', () => {
    prevSlide();
    clearInterval(autoAdvance);
    autoAdvance = setInterval(nextSlide, 5000);
  });

  nextBtn?.addEventListener('click', () => {
    nextSlide();
    clearInterval(autoAdvance);
    autoAdvance = setInterval(nextSlide, 5000);
  });

  // Dot navigation
  dots.forEach((dot, index) => {
    dot.addEventListener('click', () => {
      currentSlide = index;
      updateCarousel();
      
      // Reset auto-advance timer
      clearInterval(autoAdvance);
      autoAdvance = setInterval(nextSlide, 5000);
    });
  });

  // Touch/swipe support
  let touchStartX = 0;
  let touchEndX = 0;

  carousel?.addEventListener('touchstart', (e) => {
    touchStartX = e.changedTouches[0].screenX;
  });

  carousel?.addEventListener('touchend', (e) => {
    touchEndX = e.changedTouches[0].screenX;
    handleSwipe();
  });

  function handleSwipe() {
    if (touchEndX < touchStartX - 50) {
      // Swipe left
      currentSlide = (currentSlide + 1) % totalSlides;
      updateCarousel();
      clearInterval(autoAdvance);
      autoAdvance = setInterval(nextSlide, 5000);
    }
    if (touchEndX > touchStartX + 50) {
      // Swipe right
      currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
      updateCarousel();
      clearInterval(autoAdvance);
      autoAdvance = setInterval(nextSlide, 5000);
    }
  }
</script>
