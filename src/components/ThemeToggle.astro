---
import SunIcon from "./icons/Sun.astro";
import MoonIcon from "./icons/Moon.astro";
import SystemIcon from "./icons/System.astro";

const THEMES = ["Light", "Dark", "System"];
---

<div class="theme-toggle-wrapper relative ml-1 mr-1">
  <button
    class="theme-toggle-btn appearance-none border-none flex hover:scale-125 transition focus:outline-none focus-visible:ring-2 focus-visible:ring-violet-500 focus-visible:ring-offset-2 rounded-md text-gray-700 dark:text-gray-200"
    aria-label="Toggle theme"
    aria-haspopup="true"
    aria-expanded="false"
  >
    <span class="sr-only">Toggle theme (Light, Dark, System)</span>
    <SunIcon data-theme="light" class="theme-toggle-icon size-5 transition-all" />
    <MoonIcon
      data-theme="dark"
      class="theme-toggle-icon absolute size-5 transition-all"
    />
    <SystemIcon
      data-theme="system"
      class="theme-toggle-icon absolute size-5 transition-all"
    />
  </button>
  <div
    class="themes-menu absolute hidden top-8 right-0 text-sm p-1 min-w-[8rem] rounded-md border border-gray-200 bg-white/95 dark:bg-gray-900/95 dark:border-gray-600 shadow-[0_3px_10px_rgb(0,0,0,0.2)] backdrop-blur-md z-50"
  >
    <ul>
      {
        THEMES.map((theme) => (
          <li class="themes-menu-option px-2 py-1.5 cursor-pointer text-gray-700 dark:text-gray-200 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-sm" data-theme={theme.toLowerCase()}>
            {theme}
          </li>
        ))
      }
    </ul>
  </div>
</div>

<style>
  /* Hide all icons by default, JS will show the correct one */
  .theme-toggle-icon {
    scale: 0;
  }
  
  .themes-menu.open {
    display: block;
    animation: scale-up-center 0.15s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
  }

  @keyframes scale-up-center {
    from {
      transform: scale(0.8);
      opacity: 0;
    }
    to {
      transform: scale(1);
      opacity: 1;
    }
  }
</style>

<script is:inline>
  // Initialize theme icons immediately to prevent flash of all icons
  (function() {
    const themePreference = localStorage.getItem("theme") ?? "system";
    document.querySelectorAll(".theme-toggle-icon").forEach((element) => {
      element.style.scale = element.dataset.theme === themePreference ? "1" : "0";
    });
  })();
</script>

<script>
  function initThemeToggle() {
    const matchMedia = window.matchMedia("(prefers-color-scheme: dark)");

    const getThemePreference = () => {
      if (typeof localStorage !== "undefined") {
        return localStorage.getItem("theme") ?? "system";
      }
      return matchMedia.matches ? "dark" : "light";
    };

    const updateAllIcons = (themePreference: string) => {
      document.querySelectorAll(".theme-toggle-icon").forEach((element) => {
        const el = element as HTMLElement;
        el.style.scale = el.dataset.theme === themePreference ? "1" : "0";
      });
    };

    const updateTheme = () => {
      const themePreference = getThemePreference();
      const isDark =
        themePreference === "dark" ||
        (themePreference === "system" && matchMedia.matches);

      updateAllIcons(themePreference);
      document.documentElement.classList[isDark ? "add" : "remove"]("dark");
    };

    // Initial update
    updateTheme();

    // Listen for system theme changes
    matchMedia.addEventListener("change", updateTheme);

    // Close all menus when clicking outside
    document.addEventListener("click", () => {
      document.querySelectorAll(".themes-menu").forEach((menu) => {
        menu.classList.remove("open");
      });
    });

    // Setup all toggle buttons
    document.querySelectorAll(".theme-toggle-btn").forEach((btn) => {
      btn.addEventListener("click", (e) => {
        e.stopPropagation();
        const wrapper = btn.closest(".theme-toggle-wrapper");
        const menu = wrapper?.querySelector(".themes-menu");
        
        // Close other menus first
        document.querySelectorAll(".themes-menu").forEach((m) => {
          if (m !== menu) m.classList.remove("open");
        });
        
        menu?.classList.toggle("open");
      });
    });

    // Setup all menu options
    document.querySelectorAll(".themes-menu-option").forEach((option) => {
      option.addEventListener("click", (e) => {
        e.stopPropagation();
        const target = e.currentTarget as HTMLElement;
        const theme = target.dataset.theme;
        if (theme) {
          localStorage.setItem("theme", theme);
          updateTheme();
        }
        // Close the menu
        target.closest(".themes-menu")?.classList.remove("open");
      });
    });
  }

  // Run on initial load and after page transitions
  document.addEventListener("astro:page-load", initThemeToggle);
</script>
